package com.example.iwawka.ui.states

import com.example.iwawka.domain.models.Message

data class MainState(
    val currentChatId: String? = null,
    val messages: MessageState = MessageState.Loading,
    val input: InputState = InputState(),
    val ui: UiState = UiState(),
    val network: NetworkState = NetworkState(),
    val media: MediaState = MediaState(),
    val attachments: AttachmentState = AttachmentState()
) {
    val isLoading: Boolean get() = messages is MessageState.Loading
    val shouldShowEmptyState: Boolean
        get() = messages is MessageState.Success && messages.visibleMessages.isEmpty()
    val canSendMessage: Boolean
        get() = input.text.isNotBlank() && !isLoading

    fun withMessageSent(message: Message): MainState = copy(
        input = input.clearForNewMessage(),
        messages = messages.addMessage(message),
        network = network.copy(typingUsers = emptySet())
    )

    fun withReplyToMessage(messageId: String): MainState = copy(
        input = input.setReplyTo(messageId),
        ui = ui.copy(isEditing = true)
    )

    fun withTypingStarted(): MainState = copy(
        network = network.copy(typingUsers = network.typingUsers + "current_user")
    )

    fun cancelAllActions(): MainState = copy(
        input = input.clearAll(),
        ui = ui.copy(isEditing = false, isSelectionMode = false),
        messages = messages.clearSelection()
    )

    fun withMessagesLoaded(messages: List<Message>): MainState = copy(
        messages = MessageState.Success(messages)
    )

    fun withLoadingError(error: String): MainState = copy(
        messages = MessageState.Error(error)
    )

    fun withInputText(text: String): MainState = copy(
        input = input.copy(text = text)
    )

    // Дополнительные функции для работы с сообщениями
    fun selectMessage(id: String): MainState = copy(
        messages = messages.selectMessage(id)
    )

    fun removeMessage(id: String): MainState = copy(
        messages = messages.removeMessage(id)
    )

    fun loadMoreMessages(oldMessages: List<Message>): MainState = copy(
        messages = messages.prependMessages(oldMessages)
    )
}