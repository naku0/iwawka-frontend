package com.example.iwawka.ui.states

import com.example.iwawka.domain.models.Message

sealed class MessageState {
    data object Loading : MessageState()
    data class Success(
        val messages: List<Message> = emptyList(),
        val deletedMessageIds: Set<String> = emptySet(),
        val selectedIds: Set<String> = emptySet(),
        val hasMoreMessages: Boolean = true
    ) : MessageState()
    data class Error(val error: String) : MessageState()

    // Утилитные функции для Success состояния
    fun addMessage(message: Message): MessageState = when (this) {
        is Success -> Success(
            messages = messages + message,
            deletedMessageIds = deletedMessageIds,
            selectedIds = selectedIds,
            hasMoreMessages = hasMoreMessages
        )
        else -> this
    }

    fun prependMessages(oldMessages: List<Message>): MessageState = when (this) {
        is Success -> Success(
            messages = oldMessages + messages,
            deletedMessageIds = deletedMessageIds,
            selectedIds = selectedIds,
            hasMoreMessages = hasMoreMessages
        )
        else -> this
    }

    fun selectMessage(id: String): MessageState = when (this) {
        is Success -> Success(
            messages = messages,
            deletedMessageIds = deletedMessageIds,
            selectedIds = selectedIds + id,
            hasMoreMessages = hasMoreMessages
        )
        else -> this
    }

    fun removeMessage(id: String): MessageState = when (this) {
        is Success -> Success(
            messages = messages,
            deletedMessageIds = deletedMessageIds + id,
            selectedIds = selectedIds,
            hasMoreMessages = hasMoreMessages
        )
        else -> this
    }

    fun restoreMessage(id: String): MessageState = when (this) {
        is Success -> Success(
            messages = messages,
            deletedMessageIds = deletedMessageIds - id,
            selectedIds = selectedIds,
            hasMoreMessages = hasMoreMessages
        )
        else -> this
    }

    fun clearSelection(): MessageState = when (this) {
        is Success -> Success(
            messages = messages,
            deletedMessageIds = deletedMessageIds,
            selectedIds = emptySet(),
            hasMoreMessages = hasMoreMessages
        )
        else -> this
    }

    fun setHasMoreMessages(hasMore: Boolean): MessageState = when (this) {
        is Success -> Success(
            messages = messages,
            deletedMessageIds = deletedMessageIds,
            selectedIds = selectedIds,
            hasMoreMessages = hasMore
        )
        else -> this
    }

    // Утилитные свойства
    val visibleMessages: List<Message>
        get() = when (this) {
            is Success -> messages.filterNot { it.id in deletedMessageIds }
            else -> emptyList()
        }

    val hasSelection: Boolean
        get() = when (this) {
            is Success -> selectedIds.isNotEmpty()
            else -> false
        }

    val selectedMessages: List<Message>
        get() = when (this) {
            is Success -> messages.filter { it.id in selectedIds }
            else -> emptyList()
        }

    val selectionCount: Int
        get() = when (this) {
            is Success -> selectedIds.size
            else -> 0
        }
}